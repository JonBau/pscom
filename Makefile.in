#							-*- Makefile -*-
# ParaStation
#
# Copyright (C) 2002-2004 ParTec AG, Karlsruhe
# Copyright (C) 2005 ParTec Cluster Competence Center GmbH, Munich
#
# This file may be distributed under the terms of the Q Public License
# as defined in the file LICENSE.QPL included in the packaging of this
# file.
#
# Author:	Jens Hauke <hauke@par-tec.com>
#		Norbert Eicker <eicker@par-tec.de>
#

BUILD_MODULES=@BUILD_MODULES@
BUILD_USER=@BUILD_USER@
SRCDIR := $(shell cd @srcdir@;pwd)
export CONFIGARGS = @CONFIGARGS@
export TOP_SRCDIR = $(SRCDIR)

SUBDIRS := dist_install
ifeq ($(BUILD_MODULES),yes)
SUBDIRS += modules
all: modules

install: modules_install
endif

ifeq ($(BUILD_USER),yes)
SUBDIRS += lib bin doc
all: lib bin doc

install: user_install

endif

bin: lib

test: lib
	$(MAKE) -C bin test

.PHONY: $(SUBDIRS)
$(SUBDIRS):
	$(MAKE) -C $@ all

clean:
	@for i in $(SUBDIRS) ; do \
		$(MAKE) -C $$i clean ;\
	done
	$(MAKE) -C dist -f $(SRCDIR)/dist/Makefile clean

DISTCLEAN+= config.log
DISTCLEAN+= config.status
DISTCLEAN+= kernellist
DISTCLEAN+= Makefile

distclean:
	@for i in $(SUBDIRS) ; do \
		$(MAKE) -C $$i distclean;\
	done
	$(MAKE) -C dist -f $(SRCDIR)/dist/Makefile distclean
	$(RM) $(DISTCLEAN)

ifeq ($(RPM_BUILD_ROOT),)
modules_install:
	$(MAKE) -C modules $@

user_install:
	$(MAKE) -C dist -f Makefile.install install DISTPATH=/opt/parastation

else
modules_install:
	$(MAKE) -C modules $@ INSTALL_MOD_PATH=/$(RPM_BUILD_ROOT)

user_install:
	$(MAKE) -C dist  -f Makefile.install install DISTPATH=/$(RPM_BUILD_ROOT)/opt/parastation

endif


.PHONY: tar rpm srpm tag version
tar rpm srpm tag version:
	mkdir -p dist
	$(MAKE) -C dist -f $(SRCDIR)/dist/Makefile $@


# refresh Makefile?
Makefile: $(SRCDIR)/Makefile.in
	./config.status
