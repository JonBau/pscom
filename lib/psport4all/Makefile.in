#							-*- Makefile -*-
# ParaStation
#
# Copyright (C) 2004 ParTec AG, Karlsruhe
# Copyright (C) 2005 ParTec Cluster Competence Center GmbH, Munich
#
# This file may be distributed under the terms of the Q Public License
# as defined in the file LICENSE.QPL included in the packaging of this
# file.
#
# Authors:	Jens Hauke <hauke@par-tec.com>
#		Norbert Eicker <eicker@par-tec.de>
#

# Use absolute paths !!!
SRCDIR := $(shell cd @srcdir@;pwd)
TOPSRCDIR := @TOP_SRCDIR@
TOP_BUILDDIR:=@TOP_BUILDDIR@
GM_ENABLED:=@GM_ENABLED@
GM_HOME:=@GM_HOME@
MELLANOX_ENABLED:=@MELLANOX_ENABLED@
MELLANOX_HOME:=@MELLANOX_HOME@
OPENIB_ENABLED:=@OPENIB_ENABLED@

################################

export LIBNAME := psport4all
# export LIBSONAME := libpsport4switch.so
export LIBOBJS := psport4b.o psport_tcp.o psport_ufd.o psport_shm.o perf.o
LIBOBJS += psport_p4s.o

export LIBVPATH := $(SRCDIR)/../psport4multi
export LIBINC = -I$(TOPSRCDIR)/include -I$(SRCDIR)/../pscom
export LIBEXTERNAL_SHARED
export LIBDEF = -DNDEBUG
export LIBDSTDIR = ../..

ifeq ($(GM_ENABLED),yes)
LIBOBJS += psport_gm.o
LIBINC  += -I$(GM_HOME)/include
LIBEXTERNAL_SHARED += -Wl,-rpath,${GM_HOME}/lib -L$(GM_HOME)/lib -lgm
LIBDEF += -DENABLE_GM
endif

ifeq ($(MELLANOX_ENABLED),yes)
LIBOBJS += psport_mvapi.o
LIBINC += -I$(MELLANOX_HOME)/include
LIBEXTERNAL_SHARED += -Wl,-rpath,$(MELLANOX_HOME)/lib -L$(MELLANOX_HOME)/lib -lvapi -lmtl_common -lmosal -lmpga -lpthread
LIBDEF += -D__LINUX__ -DMT_LITTLE_ENDIAN -DENABLE_MVAPI -DNDEBUG
endif

ifeq ($(OPENIB_ENABLED),yes)
LIBOBJS += psport_openib.o
LIBEXTERNAL_SHARED += -libverbs
LIBDEF += -DENABLE_OPENIB
endif



################################

all lib: sharedlib staticlib

sharedlib staticlib: sharedlib.dir staticlib.dir
	$(MAKE) -C $@.dir -f ../../Makefile.$@

sharedlib.dir staticlib.dir:
	mkdir -p $@

clean:
	$(MAKE) -C sharedlib.dir -f ../../Makefile.sharedlib clean || echo nevermind
	$(MAKE) -C staticlib.dir -f ../../Makefile.staticlib clean || echo nevermind

distclean:
	$(MAKE) -C sharedlib.dir -f ../../Makefile.sharedlib distclean || echo nevermind
	$(MAKE) -C staticlib.dir -f ../../Makefile.staticlib distclean || echo nevermind
	$(RM) -r sharedlib.dir staticlib.dir
	$(RM) Makefile

Makefile: $(SRCDIR)/Makefile.in
	cd $(TOP_BUILDDIR); ./config.status
